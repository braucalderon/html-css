import e,{useRef as t,useContext as r,useEffect as s}from"react";const o=e.createContext();o.displayName="ClientContext";var n=function(e){var t=e.name,r=e.type;this.uri=e.uri,this.name=t,this.type=r},a=function(e){return"undefined"!=typeof File&&e instanceof File||"undefined"!=typeof Blob&&e instanceof Blob||e instanceof n};const i=e=>a(e)||null!==e&&"object"==typeof e&&"function"==typeof e.pipe;class c{constructor(e={}){if(!e.url)throw Error("GraphQLClient: config.url is required");if(e.fetch&&"function"!=typeof e.fetch)throw Error("GraphQLClient: config.fetch must be a function");if(!e.fetch&&!fetch)throw Error("GraphQLClient: fetch must be polyfilled or passed in new GraphQLClient({ fetch })");if(e.ssrMode&&!e.cache)throw Error("GraphQLClient: config.cache is required when in ssrMode");this.cache=e.cache,this.headers=e.headers||{},this.ssrMode=e.ssrMode,this.ssrPromises=[],this.url=e.url,this.fetch=e.fetch||fetch.bind(),this.fetchOptions=e.fetchOptions||{},this.FormData=e.FormData||("undefined"!=typeof FormData?FormData:void 0),this.logErrors=void 0===e.logErrors||e.logErrors,this.onError=e.onError,this.useGETForQueries=!0===e.useGETForQueries,this.subscriptionClient=e.subscriptionClient}setHeader(e,t){return this.headers[e]=t,this}setHeaders(e){return this.headers=e,this}removeHeader(e){return delete this.headers[e],this}logErrorResult({result:e,operation:t}){console.error("GraphQL Hooks Error"),console.groupCollapsed("---\x3e Full Error Details"),console.groupCollapsed("Operation:"),console.log(t),console.groupEnd();const r=e.error;r&&(r.fetchError&&(console.groupCollapsed("FETCH ERROR:"),console.log(r.fetchError),console.groupEnd()),r.httpError&&(console.groupCollapsed("HTTP ERROR:"),console.log(r.httpError),console.groupEnd()),r.graphQLErrors&&r.graphQLErrors.length>0&&(console.groupCollapsed("GRAPHQL ERROR:"),r.graphQLErrors.forEach(e=>console.log(e)),console.groupEnd())),console.groupEnd()}generateResult({fetchError:e,httpError:t,graphQLErrors:r,data:s}){return!!(r&&r.length>0||e||t)?{data:s,error:{fetchError:e,httpError:t,graphQLErrors:r}}:{data:s}}getCacheKey(e,t={}){return{operation:e,fetchOptions:{...this.fetchOptions,...t.fetchOptionsOverrides}}}getCache(e){const t=this.cache?this.cache.get(e):null;if(t)return t}saveCache(e,t){this.cache&&this.cache.set(e,t)}getFetchOptions(e,t={}){const r={method:"POST",headers:{...this.headers},...this.fetchOptions,...t};if("GET"===r.method)return r;const{clone:s,files:o}=function e(t,r,s){var o;void 0===r&&(r=""),void 0===s&&(s=a);var n=new Map;function i(e,t){var r=n.get(t);r?r.push.apply(r,e):n.set(t,e)}if(s(t))o=null,i([r],t);else{var c=r?r+".":"";if("undefined"!=typeof FileList&&t instanceof FileList)o=Array.prototype.map.call(t,(function(e,t){return i([""+c+t],e),null}));else if(Array.isArray(t))o=t.map((function(t,r){var o=e(t,""+c+r,s);return o.files.forEach(i),o.clone}));else if(t&&t.constructor===Object)for(var u in o={},t){var h=e(t[u],""+c+u,s);h.files.forEach(i),o[u]=h.clone}else o=t}return{clone:o,files:n}}(e,"",i),n=JSON.stringify(s);if(o.size){if(!this.FormData)throw Error("GraphQLClient: FormData must be polyfilled or passed in new GraphQLClient({ FormData })");const e=new this.FormData;e.append("operations",n);const t={};let s=0;o.forEach(e=>{t[++s]=e}),e.append("map",JSON.stringify(t)),s=0,o.forEach((t,r)=>{e.append(`${++s}`,r,r.name)}),r.body=e}else r.headers["Content-Type"]="application/json",r.body=n;return r}request(e,t={}){let r=this.url;if("GET"===this.getFetchOptions(e,t.fetchOptionsOverrides).method){r=r+"?"+Object.entries(e).filter(([,e])=>!!e).map(([e,t])=>("variables"===e&&(t=JSON.stringify(t)),`${e}=${encodeURIComponent(t)}`)).join("&")}return this.fetch(r,this.getFetchOptions(e,t.fetchOptionsOverrides)).then(e=>e.ok?e.json().then(({errors:e,data:t})=>this.generateResult({graphQLErrors:e,data:t})):e.text().then(t=>{const{status:r,statusText:s}=e;return this.generateResult({httpError:{status:r,statusText:s,body:t}})})).catch(e=>this.generateResult({fetchError:e})).then(t=>(t.error&&(this.logErrors&&this.logErrorResult({result:t,operation:e}),this.onError&&this.onError({result:t,operation:e})),t))}createSubscription(e){if(!this.subscriptionClient)throw Error("No SubscriptionClient! Please set in the constructor.");return this.subscriptionClient.request(e)}}const u="RESET_STATE",h="LOADING",l="CACHE_HIT",p="REQUEST_RESULT";function f(e,t){switch(t.type){case u:return t.initialState;case h:return e.loading?e:{...e,loading:!0};case l:return e.cacheHit&&!t.resetState?e:{...t.result,cacheHit:!0,loading:!1};case p:return{...t.result,data:e.data&&t.result.data&&t.updateData?t.updateData(e.data,t.result.data):t.result.data,cacheHit:!1,loading:!1};default:return e}}function d(t,r){const s=e.useRef();return function e(t,r){var s,o;if(t===r)return!0;if(t&&r&&(s=t.constructor)===r.constructor){if(s===Date)return t.getTime()===r.getTime();if(s===RegExp)return""+t==""+r;if(s===Array&&(o=t.length)===r.length){for(;o--&&e(t[o],r[o]););return-1===o}if(s===Object){if(Object.keys(t).length!==Object.keys(r).length)return!1;for(o in t)if(!(o in r&&e(t[o],r[o])))return!1;return!0}}return t!=t&&r!=r}(r,s.current)||(s.current=r),e.useCallback(t,s.current)}function g(t,r={}){if("string"!=typeof t)throw Error("Your query must be a string. If you are using the `gql` template literal from graphql-tag, remove it from your query.");const s=e.useContext(o),n=e.useRef(!0),a=e.useRef(null),i={query:t,variables:r.variables,operationName:r.operationName};s.useGETForQueries&&!r.isMutation&&(r.fetchOptionsOverrides={...r.fetchOptionsOverrides,method:"GET"});const c=s.getCacheKey(i,r),g=r.isMutation||r.isManual,E=r.skipCache||!s.cache?null:s.cache.get(c),y={...E,cacheHit:!!E,loading:!g&&!E},[C,m]=e.useReducer(f,y),b=JSON.stringify(c);e.useEffect(()=>{r.updateData||m({type:u,initialState:y})},[b]),e.useEffect(()=>(n.current=!0,()=>{n.current=!1}),[]);const O=d(e=>{if(!n.current)return Promise.resolve();const t={...r,...e},o={...i,variables:t.variables,operationName:t.operationName},c=s.getCacheKey(o,t);a.current=c;const u=t.skipCache?null:s.getCache(c);return u?(m({type:l,result:u,resetState:b!==JSON.stringify(C.cacheKey)}),Promise.resolve(u)):(m({type:h}),s.request(o,t).then(e=>{if(t.updateData&&"function"!=typeof t.updateData)throw Error("options.updateData must be a function");const r={...e};if(t.useCache&&(r.useCache=!0,r.cacheKey=c,s.ssrMode)){const e={data:t.updateData?t.updateData(C.data,r.data):r.data};s.saveCache(c,e)}return n.current&&c===a.current&&m({type:p,updateData:t.updateData,result:r}),e}))},[s,r,i]);return e.useEffect(()=>{C.useCache&&s.saveCache(C.cacheKey,C)},[s,C]),[O,C]}const E={useCache:!0};function y(t,r={}){const s={...E,...r},n=e.useContext(o),[a,i]=e.useState(!1),[c,u]=g(t,s);if(n.ssrMode&&!1!==r.ssr&&!a&&!r.skipCache){if(!u.data&&!u.error){const e=c();n.ssrPromises.push(e)}i(!0)}const h=JSON.stringify(s);return e.useEffect(()=>{c()},[t,h]),{...u,refetch:e.useCallback((e={})=>c({skipCache:!0,updateData:(e,t)=>t,...e}),[c])}}function C(e,n){const a=t(n);a.current=n;const i=r(o),c={query:e.query,variables:e.variables};s(()=>{const e=i.createSubscription(c).subscribe({next:e=>{a.current(e)},error:()=>{e.unsubscribe()},complete:()=>{e.unsubscribe()}});return()=>{e.unsubscribe()}},[])}const m=(e,t)=>g(e,{useCache:!0,isManual:!0,...t}),b=(e,t)=>g(e,{isMutation:!0,...t});export{o as ClientContext,c as GraphQLClient,g as useClientRequest,m as useManualQuery,b as useMutation,y as useQuery,C as useSubscription};
